// Flow that takes care of registering a new Passkey
Flow org.gluu.agama.passkey.add
     Basepath ""
     Inputs userData
// Set "inum" obtained from userData
inum = userData.inum
// Get Instance FidoEnroller
fidoEnroller = Call org.gluu.agama.passkey.enroll.FidoEnroller#new 
// Declaration of the variable "obj" with initial data
obj = { attestation: "{}", isAttestation: false, showError: false, errorTitle: "", errorMessage: "" }
Repeat 5 times max
     // Load passkey-add.ftlh page
     addDeviceForm = RRF "passkey-add.ftlh" obj
     When addDeviceForm.addPasskeyBtn is ""
          // Invoke the method to initiate passkey registration
          detestable = Call fidoEnroller getAttestationMessage inum
          // Show registration flow
          obj.isAttestation = true
          obj.attestation = detestable
          obj.showError = false
     When addDeviceForm.skipped is "skipped"
          obj.isAttestation = false
          obj.showError = true
          obj.errorTitle = "Passkey registration failed."
          obj.errorMessage = addDeviceForm.errorMessage
     When addDeviceForm.tokenResponse is not ""
          key | E = Call fidoEnroller verifyRegistration inum addDeviceForm.tokenResponse
          When E is null and key is not null
               nicknameTrigger = Trigger org.gluu.agama.passkey.nickname key userData
               obj.isAttestation = false
               it_pcrup = {success:true, data: { userId: inum, response: nicknameTrigger }}
               Finish it_pcrup
          When E is not null
               obj.isAttestation = false
               obj.showError = true
               obj.errorTitle = "Passkey registration failed."
               obj.errorMessage = E.message
     When addDeviceForm.cancelBtn is ""
          it_soswc = {success:false, error: "Cancel event"}
          Finish it_soswc
// Finish with error, because the limit of attempts was exceeded.
it_vehhb = {success:false, error: "Passkey registration attempt exceeded."}
Finish it_vehhb